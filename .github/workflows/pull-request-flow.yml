name: Validate PR Checks
on:
  pull_request:
    branches:
      - main

jobs:
  VerifyAndTest:
    runs-on: ubuntu-latest
    steps:
      - run: echo "The job was automatically triggered by a ${{ github.event_name }} event."

      - run: echo "üîé Branch to be evaluated ${{ github.ref }}"
        name: Check out repository code
      - uses: actions/checkout@v4
      - run: echo "üí° The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "üñ•Ô∏è The workflow is now ready to start execution"

      - run: echo "‚òï Set up Java for the workflow"
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      - run: echo "Java is already configured in the runner"

      - run: echo "üêò Set up Gradle for the workflow"
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-disabled: true

      - run: echo "Running pull request verifications"
      - name: Execute Gradle VerifyChanges
        run: ./gradlew verifyChanges -PverifyCoverage

      - run: echo "Running build command"
      - name: Execute Gradle Assemble Debug
        run: ./gradlew :app-phone:assembleDebug

      - name: Upload Debug APK Build
        uses: actions/upload-artifact@v3
        with:
          name: app-phone-debug
          path: apps/app-phone/build/outputs/apk/debug/app-phone-debug.apk
          if-no-files-found: error
          retention-days: 7

  PostArtifactUrl:
    needs: VerifyAndTest
    runs-on: ubuntu-latest
    steps:
      - name: Get Artifact URL & PR Info
        env:
          GITHUB_TOKEN: ${{ github.token }}
          WORKFLOW_RUN_EVENT_OBJ: ${{ toJSON(github.event.workflow_run) }}
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          PREVIOUS_JOB_ID=$(jq -r '.id' <<< "$WORKFLOW_RUN_EVENT_OBJ")
          echo "Previous Job ID: $PREVIOUS_JOB_ID"
          echo "PREVIOUS_JOB_ID=$PREVIOUS_JOB_ID" >> "$GITHUB_ENV"

          SUITE_ID=$(jq -r '.check_suite_id' <<< "$WORKFLOW_RUN_EVENT_OBJ")
          echo "Previous Suite ID: $SUITE_ID"
          echo "SUITE_ID=$SUITE_ID" >> "$GITHUB_ENV"

          ARTIFACT_ID=$(gh api "/repos/$OWNER/$REPO/actions/artifacts" \
          --jq ".artifacts.[] |
          select(.workflow_run.id==${PREVIOUS_JOB_ID}) |
          select(.expired==false) |
          .id")

          echo "Artifact ID: $ARTIFACT_ID"
          echo "ARTIFACT_ID=$ARTIFACT_ID" >> "$GITHUB_ENV"

          PR_NUMBER=$(jq -r '.pull_requests[0].number' \
          <<< "$WORKFLOW_RUN_EVENT_OBJ")

          echo "Pull request Number: $PR_NUMBER"
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"

          HEAD_SHA=$(jq -r '.pull_requests[0].head.sha' \
          <<< "$WORKFLOW_RUN_EVENT_OBJ")

          echo "Head SHA: $HEAD_SHA"
          echo "HEAD_SHA=$HEAD_SHA" >> "$GITHUB_ENV"

      - name: Find Comment
        uses: peter-evans/find-comment@v2
        id: find-comment
        with:
          issue-number: ${{ env.PR_NUMBER }}
          comment-author: 'github-actions[bot]'
      - name: Update Comment
        env:
          JOB_PATH: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ env.PREVIOUS_JOB_ID }}"
          ARTIFACT_URL: "${{ github.server_url }}/${{ github.repository }}/suites/${{ env.SUITE_ID }}/artifacts/${{ env.ARTIFACT_ID }}"
          HEAD_SHA: "${{ env.HEAD_SHA }}"
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ env.PR_NUMBER }}
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          edit-mode: replace
          body: |-
            ‚úÖ Build Successful! ‚úÖ

            | Name     | Link                    |
            | -------- | ----------------------- |
            | Commit   | ${{ env.HEAD_SHA }}     |
            | Logs     | ${{ env.JOB_PATH }}     |
            | APK      | ${{ env.ARTIFACT_URL }} |

      - run: echo "Finishing publishing build comment"
